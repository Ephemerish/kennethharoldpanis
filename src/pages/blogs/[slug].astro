---
import MainLayout from "../../layouts/MainLayout.astro";
import { getEntryBySlug, getCollection } from "astro:content";
import HeroIcon from "../../components/HeroIcon.tsx";
import { formatDate, calculateReadTime } from "../../utils";
import { Image } from 'astro:assets';

export const prerender = true;

export async function getStaticPaths() {
  const blogEntries = await getCollection("blog");
  return blogEntries.map(entry => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}

const { slug } = Astro.params;
const { entry } = Astro.props;
let Content, frontmatter, readTime;
if (entry) {
  const rendered = await entry.render();
  Content = rendered.Content;
  frontmatter = entry.data;
  readTime = calculateReadTime(entry.body);
}
---

<MainLayout title={frontmatter?.title || "Blog Post"}>
  {entry ? (
    <div class="max-w-4xl mx-auto px-6 py-8 bg-neutral rounded-xl shadow-sm my-8">
      {/* Hero Section */}
      <header class="mb-8">
        <h1 class="text-4xl md:text-5xl font-bold text-neutral-900 mb-4 leading-tight">
          {frontmatter?.title}
        </h1>
        <div class="flex items-center justify-between flex-wrap gap-4 mb-6">
          <div class="flex items-center gap-4 text-neutral-700">
            <time class="flex items-center gap-1.5 text-sm">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
              </svg>
              {frontmatter?.pubDate && formatDate(frontmatter.pubDate)}
            </time>
            <span class="text-neutral-400">•</span>
            <span class="flex items-center gap-1.5 text-sm">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              {readTime}
            </span>
          </div>
          {frontmatter?.tags && (
            <div class="flex flex-wrap gap-2">
              {frontmatter.tags.map((tag) => (
                <span class="px-2.5 py-1 bg-brand-50 text-brand-600 text-xs font-normal rounded-md hover:bg-brand-100 transition-colors">
                  {tag}
                </span>
              ))}
            </div>
          )}
        </div>
        {frontmatter?.image && (
          <div class="mb-8">
            <Image 
              src={"/images/" + frontmatter.image} 
              alt={frontmatter?.title || "Blog post image"} 
              class="w-full h-64 md:h-96 object-cover rounded-lg shadow-lg"
              width={800}
              height={400}
              loading="eager"
            />
          </div>
        )}
      </header>

      {/* Article Content */}
      <article class="
        text-neutral-700 text-sm sm:text-base lg:text-lg leading-6 sm:leading-7 lg:leading-8 font-light
        [&>h1]:text-xl [&>h1]:sm:text-2xl [&>h1]:font-medium [&>h1]:text-neutral-900 [&>h1]:mt-6 [&>h1]:sm:mt-8 [&>h1]:mb-3 [&>h1]:sm:mb-4 [&>h1]:tracking-tight [&>h1]:pb-2 [&>h1]:border-b [&>h1]:border-neutral-100
        [&>h2]:text-lg [&>h2]:sm:text-xl [&>h2]:font-semibold [&>h2]:text-neutral-900 [&>h2]:mt-6 [&>h2]:sm:mt-8 [&>h2]:mb-3 [&>h2]:sm:mb-4 [&>h2]:tracking-tight [&>h2]:pb-2 [&>h2]:border-b-2 [&>h2]:border-brand-500
        [&>h3]:text-base [&>h3]:sm:text-lg [&>h3]:font-medium [&>h3]:text-neutral-900 [&>h3]:mt-5 [&>h3]:sm:mt-6 [&>h3]:mb-2 [&>h3]:sm:mb-3 [&>h3]:tracking-tight [&>h3]:pb-1.5 [&>h3]:border-b [&>h3]:border-brand-300
        [&>h4]:text-sm [&>h4]:sm:text-base [&>h4]:font-medium [&>h4]:text-neutral-900 [&>h4]:mt-4 [&>h4]:sm:mt-5 [&>h4]:mb-2 [&>h4]:bg-neutral-50 [&>h4]:border-l-3 [&>h4]:border-brand-300 [&>h4]:px-3 [&>h4]:py-1.5 [&>h4]:rounded-r-md
        [&>p]:mb-3 [&>p]:sm:mb-4 [&>p]:leading-6 [&>p]:sm:leading-7 [&>p]:lg:leading-8
        [&>ul]:mb-3 [&>ul]:sm:mb-4 [&>ul]:space-y-1 [&>ul]:sm:space-y-2 [&>ul>li]:relative [&>ul>li]:pl-6 [&>ul>li]:sm:pl-8 [&>ul>li]:before:content-['●'] [&>ul>li]:before:absolute [&>ul>li]:before:left-0 [&>ul>li]:before:text-brand-600 [&>ul>li]:before:font-bold [&>ul>li]:before:text-sm [&>ul>li]:sm:before:text-lg [&>ul>li]:before:top-0
        [&>ol]:mb-3 [&>ol]:sm:mb-4 [&>ol]:space-y-1 [&>ol]:sm:space-y-2 [&>ol]:ml-6 [&>ol]:sm:ml-8 [&>ol]:list-decimal [&>ol]:marker:text-brand-600 [&>ol]:marker:font-semibold [&>ol]:marker:text-sm [&>ol]:sm:marker:text-lg [&>ol>li]:mb-1 [&>ol>li]:pl-1 [&>ol>li]:sm:pl-2
        [&>blockquote]:border-l-2 [&>blockquote]:border-brand-200 [&>blockquote]:pl-3 [&>blockquote]:sm:pl-4 [&>blockquote]:text-neutral-600 [&>blockquote]:italic [&>blockquote]:my-4 [&>blockquote]:sm:my-6 [&>blockquote]:text-base [&>blockquote]:sm:text-lg
        [&>pre]:bg-neutral-50 [&>pre]:border [&>pre]:border-neutral-100 [&>pre]:p-3 [&>pre]:sm:p-4 [&>pre]:rounded-xl [&>pre]:overflow-x-auto [&>pre]:my-4 [&>pre]:sm:my-6 [&>pre]:text-xs [&>pre]:sm:text-sm [&>pre]:leading-5 [&>pre]:sm:leading-6
        [&>:not(pre)>code]:bg-brand-100 [&>:not(pre)>code]:px-1.5 [&>:not(pre)>code]:sm:px-2 [&>:not(pre)>code]:py-0.5 [&>:not(pre)>code]:rounded [&>:not(pre)>code]:text-xs [&>:not(pre)>code]:sm:text-sm [&>:not(pre)>code]:font-mono [&>:not(pre)>code]:text-brand-800
        [&>a]:text-brand-600 [&>a]:underline [&>a]:decoration-brand-300 [&>a]:underline-offset-4 [&>a]:transition-colors [&>a:hover]:decoration-brand-600
        [&>img]:rounded-xl [&>img]:my-4 [&>img]:sm:my-6 [&>img]:border [&>img]:border-neutral-100
        [&>hr]:border-0 [&>hr]:h-px [&>hr]:bg-neutral-200 [&>hr]:my-6 [&>hr]:sm:my-8
        first:*:mt-0
      " id="article-content">
        {Content && <Content />}
      </article>

      <script>
        document.addEventListener('DOMContentLoaded', function() {
          const article = document.getElementById('article-content');
          if (!article) return;

          // Enhance tables with better styling and responsive containers
          const tables = article.querySelectorAll('table');
          tables.forEach(table => {
            const parent = table.parentElement;
            if (parent && !parent.classList.contains('table-wrapper')) {
              const wrapper = document.createElement('div');
              wrapper.className = 'table-wrapper overflow-x-auto my-6 border border-gray-200 rounded-lg shadow-sm bg-white';
              parent.insertBefore(wrapper, table);
              wrapper.appendChild(table);
              
              // Enhanced table styling
              table.className = 'w-full border-collapse text-sm min-w-full';
              
              // Style table headers
              const headers = table.querySelectorAll('th');
              headers.forEach(th => {
                th.className = 'bg-gray-50 border-b-2 border-gray-200 px-4 py-3 text-left font-semibold text-gray-900 text-xs uppercase tracking-wider';
              });
              
              // Style table cells
              const cells = table.querySelectorAll('td');
              cells.forEach(td => {
                td.className = 'border-b border-gray-100 px-4 py-3 text-gray-700 text-sm whitespace-nowrap';
              });
              
              // Add alternating row colors
              const rows = table.querySelectorAll('tbody tr');
              rows.forEach((row, index) => {
                if (index % 2 === 1) {
                  row.className = 'bg-gray-25';
                }
              });
            }
          });

          // Check if button already exists to prevent duplicates
          if (document.querySelector('[data-collapse-button]')) return;

          // Create collapse button with improved icons
          const collapseBtn = document.createElement('button');
          collapseBtn.innerHTML = `
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
          `;
          collapseBtn.className = 'fixed top-20 right-2 sm:right-4 z-50 w-11 h-11 sm:w-12 sm:h-12 bg-white/95 backdrop-blur-sm text-slate-700 rounded-full hover:bg-white hover:scale-105 transition-all duration-200 border border-slate-200 hover:border-slate-300 shadow-lg hover:shadow-xl flex items-center justify-center';
          collapseBtn.setAttribute('data-collapse-button', 'true');
          
          // Create tooltip with improved wording
          const tooltip = document.createElement('div');
          tooltip.innerHTML = 'Hide All Sections';
          tooltip.className = 'fixed top-20 right-14 sm:right-16 z-50 bg-slate-800 text-white px-3 py-1.5 rounded-lg text-xs sm:text-sm font-medium shadow-lg opacity-0 pointer-events-none transition-all duration-200 whitespace-nowrap';
          tooltip.setAttribute('data-collapse-tooltip', 'true');
          
          // Add hover events for tooltip
          collapseBtn.addEventListener('mouseenter', () => {
            tooltip.style.opacity = '1';
            tooltip.style.transform = 'translateX(-4px)';
          });
          
          collapseBtn.addEventListener('mouseleave', () => {
            tooltip.style.opacity = '0';
            tooltip.style.transform = 'translateX(0)';
          });
          
          let sectionsCollapsed = false;
          
          function initializeCollapsible() {
            if (!article) return;
            
            const headers = article.querySelectorAll('h2, h3');
            
            headers.forEach(header => {
              // Add click indicator with better icon
              const indicator = document.createElement('span');
              indicator.innerHTML = `
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 9l-7 7-7-7"></path>
                </svg>
              `;
              indicator.className = 'absolute right-2 top-1/2 transform -translate-y-1/2 text-white/70 text-xs select-none transition-all duration-200';
              header.appendChild(indicator);
              
              // Find content until next header of same/higher level
              const contentElements: Element[] = [];
              let sibling = header.nextElementSibling;
              const headerLevel = parseInt(header.tagName.charAt(1));
              
              while (sibling) {
                const siblingLevel = sibling.tagName.match(/^H[1-6]$/) ? 
                  parseInt(sibling.tagName.charAt(1)) : null;
                
                if (siblingLevel && siblingLevel <= headerLevel) {
                  break;
                }
                
                contentElements.push(sibling);
                sibling = sibling.nextElementSibling;
              }
              
              if (contentElements.length > 0) {
                // Store original styles and add data attributes for tracking
                header.setAttribute('data-collapsible', 'true');
                
                contentElements.forEach((el, index) => {
                  el.setAttribute('data-section-content', header.tagName.toLowerCase() + '-' + Array.from(article.children).indexOf(header));
                  el.setAttribute('data-original-display', window.getComputedStyle(el).display);
                });
                
                // Add click handler
                header.addEventListener('click', () => {
                  const isCollapsed = header.getAttribute('data-collapsed') === 'true';
                  
                  if (isCollapsed) {
                    // Expand
                    contentElements.forEach(el => {
                      (el as HTMLElement).style.display = el.getAttribute('data-original-display') || 'block';
                      (el as HTMLElement).style.opacity = '1';
                      (el as HTMLElement).style.transform = 'translateY(0)';
                    });
                    header.setAttribute('data-collapsed', 'false');
                    indicator.innerHTML = `
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 9l-7 7-7-7"></path>
                      </svg>
                    `;
                  } else {
                    // Collapse
                    contentElements.forEach(el => {
                      (el as HTMLElement).style.display = 'none';
                      (el as HTMLElement).style.opacity = '0';
                      (el as HTMLElement).style.transform = 'translateY(-10px)';
                    });
                    header.setAttribute('data-collapsed', 'true');
                    indicator.innerHTML = `
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5l7 7-7 7"></path>
                      </svg>
                    `;
                  }
                });
              }
            });
          }
          
          collapseBtn.addEventListener('click', () => {
            if (!article) return;
            
            const collapsibleHeaders = article.querySelectorAll('[data-collapsible="true"]');
            
            if (sectionsCollapsed) {
              // Expand all
              collapsibleHeaders.forEach(header => {
                const indicator = header.querySelector('span');
                const sectionId = header.tagName.toLowerCase() + '-' + Array.from(article.children).indexOf(header);
                const contentElements = article.querySelectorAll('[data-section-content="' + sectionId + '"]');
                
                contentElements.forEach(el => {
                  (el as HTMLElement).style.display = el.getAttribute('data-original-display') || 'block';
                  (el as HTMLElement).style.opacity = '1';
                  (el as HTMLElement).style.transform = 'translateY(0)';
                });
                header.setAttribute('data-collapsed', 'false');
                if (indicator) indicator.innerHTML = `
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 9l-7 7-7-7"></path>
                  </svg>
                `;
              });
              collapseBtn.innerHTML = `
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M4 6h16M4 12h16M4 18h16"></path>
                </svg>
              `;
              tooltip.innerHTML = 'Hide All Sections';
            } else {
              // Collapse all
              collapsibleHeaders.forEach(header => {
                const indicator = header.querySelector('span');
                const sectionId = header.tagName.toLowerCase() + '-' + Array.from(article.children).indexOf(header);
                const contentElements = article.querySelectorAll('[data-section-content="' + sectionId + '"]');
                
                contentElements.forEach(el => {
                  (el as HTMLElement).style.display = 'none';
                  (el as HTMLElement).style.opacity = '0';
                  (el as HTMLElement).style.transform = 'translateY(-10px)';
                });
                header.setAttribute('data-collapsed', 'true');
                if (indicator) indicator.innerHTML = `
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5l7 7-7 7"></path>
                  </svg>
                `;
              });
              collapseBtn.innerHTML = `
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M8 9l4-4 4 4m0 6l-4 4-4-4"></path>
                </svg>
              `;
              tooltip.innerHTML = 'Show All Sections';
            }
            
            sectionsCollapsed = !sectionsCollapsed;
          });
          
          // Clean up any existing buttons/tooltips before adding new ones
          const existingButton = document.querySelector('[data-collapse-button]');
          const existingTooltip = document.querySelector('[data-collapse-tooltip]');
          if (existingButton) existingButton.remove();
          if (existingTooltip) existingTooltip.remove();
          
          // Add floating button and tooltip to body
          document.body.appendChild(collapseBtn);
          document.body.appendChild(tooltip);
          
          // Initialize
          initializeCollapsible();
        });
      </script>

      {/* Navigation/Back Button */}
      <div class="mt-12 pt-8 border-t border-gray-200">
        <a 
          href="/blogs" 
          class="inline-flex items-center gap-2 text-black hover:text-gray-700 font-medium transition-colors"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
          Back to all posts
        </a>
      </div>
    </div>
  ) : (
    <div class="text-center py-16">
      <h2 class="text-2xl font-bold text-gray-900 mb-4">Article not found</h2>
      <p class="text-gray-600 mb-8">The blog post you are looking for does not exist.</p>
      <a 
        href="/blogs" 
        class="inline-flex items-center gap-2 px-6 py-3 bg-black text-white rounded-lg hover:bg-gray-800 transition-colors"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
        Back to all posts
      </a>
    </div>
  )}
</MainLayout>
